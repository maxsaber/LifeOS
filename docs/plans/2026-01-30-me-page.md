# "Me" Page - Product Requirements Document

**Date:** 2026-01-30
**Owner Person ID:** `3f41e143-719f-4dc9-a9f1-389b2db5b166` (Nathan Ramia)
**Status:** In Progress

---

## Problem Statement

The CRM profile page for the owner ("myself") shows sparse/meaningless data because it only displays interactions with oneself (self-texts, self-emails). This page should instead be a personal CRM dashboard showing aggregate insights across all relationships.

## Goals

1. Transform the owner's profile into a meaningful personal dashboard
2. Maintain existing functionality for all other person profiles
3. Maximize client-side processing for durability across syncs
4. Reuse existing patterns/pathways where possible

---

## Requirements

### R1: URL Routing

**R1.1** `/me` URL shall load the owner's profile page
**R1.2** `/crm/{owner_id}` shall render the same "me" dashboard
**R1.3** Navigation between tabs (`/me`, `/me/graph`) shall work correctly

### R2: Hero Bar - Aggregate Stats

**R2.1** When viewing the "me" page, hero bar shall display:
- Total people in CRM
- Total emails across all interactions
- Total meetings across all interactions
- Total messages across all interactions

**R2.2** Stats shall be fetched from a new API endpoint

### R3: 365-Day Heatmap - Daily Activity

**R3.1** Heatmap shall show daily interaction volume across ALL people (not just self)
**R3.2** Color intensity shall represent total interactions that day
**R3.3** Tooltip shall show count for the day
**R3.4** Visual style shall match existing heatmap

### R4: Self-Insights (Facts Section)

**R4.1** Shall reuse existing `PersonFactExtractor` pathway
**R4.2** Shall create a new prompt variant for self-insights
**R4.3** Shall sample interactions from circle 0-2 contacts
**R4.4** Insights shall focus on:
- Communication patterns
- Relationship observations
- Notable trends

**R4.5** Shall use same fact storage/display infrastructure

### R5: Top Contacts Widget

**R5.1** Shall display most-interacted-with people
**R5.2** Shall show name, avatar, interaction count
**R5.3** Clicking a contact shall navigate to their profile
**R5.4** Shall be configurable by time period (week/month/all-time)

### R6: Interaction Breakdown Charts

**R6.1** Shall display 100% stacked bar charts showing interaction distribution
**R6.2** Chart variants:
- By Source (iMessage, Email, Calendar, etc.)
- By Month (last 12 months)
- By Dunbar Circle (0-5)

**R6.3** Charts shall be filterable/interactive
**R6.4** Processing shall be done client-side from interaction data
**R6.5** Shall use existing interaction data fetched via API

### R7: Relationship Trends Widget

**R7.1** Shall identify people with notable interaction changes
**R7.2** Comparison periods:
- Recent 2 weeks vs. previous 2 weeks
- Recent 2 months vs. previous 2 months
- This year vs. previous year

**R7.3** Shall show:
- "Warming" relationships (increased interaction)
- "Cooling" relationships (decreased interaction)

**R7.4** Processing shall be done client-side

### R8: Graph Tab

**R8.1** Graph tab shall remain unchanged (already useful for network view)

---

## Technical Design

### API Endpoints

#### GET /api/crm/me/stats
Returns aggregate statistics across all people.

```json
{
  "total_people": 5350,
  "total_emails": 12543,
  "total_meetings": 892,
  "total_messages": 45231
}
```

#### GET /api/crm/me/interactions
Returns all interactions for the owner (for client-side processing).
Uses existing interaction store, filtered to owner's interactions.

```json
{
  "interactions": [
    {
      "id": "...",
      "person_id": "...",
      "person_name": "Taylor Walker",
      "source_type": "imessage",
      "interaction_date": "2026-01-30",
      "dunbar_circle": 0
    },
    ...
  ]
}
```

#### POST /api/crm/me/insights/extract
Triggers self-insight extraction using modified prompt.
Reuses `PersonFactExtractor` with `mode="self_insights"`.

### Frontend Architecture

```
/me or /crm/{owner_id}
├── isMyPage() detection
├── Hero Bar (R2)
│   └── Calls /api/crm/me/stats
├── Overview Tab
│   ├── Heatmap (R3)
│   │   └── Client-side from interactions
│   ├── Self-Insights (R4)
│   │   └── Reuses fact display component
│   ├── Top Contacts (R5)
│   │   └── Client-side from interactions
│   ├── Breakdown Charts (R6)
│   │   └── Client-side from interactions
│   └── Relationship Trends (R7)
│       └── Client-side from interactions
└── Graph Tab (R8)
    └── Unchanged
```

### Data Flow

1. Page load fetches `/api/crm/me/stats` for hero bar
2. Page load fetches `/api/crm/me/interactions` (single call)
3. Client-side JavaScript processes interactions for:
   - Heatmap (group by date, count)
   - Top contacts (group by person, count, sort)
   - Breakdown charts (group by source/month/circle)
   - Relationship trends (compare time periods)
4. Insights use existing fact infrastructure with new prompt

---

## Implementation Phases

### Phase 1: Foundation ✅
- [x] Add `MY_PERSON_ID` constant (in crm.py and DUNBAR_CONFIG in crm.html)
- [x] Add `/me` URL routing in JavaScript (parseUrl, updateUrl)
- [x] Add `isMyPage()` helper function
- [x] Add server-side `/me` route (main.py)

### Phase 2: API Endpoints ✅
- [x] Create `GET /api/crm/me/stats` endpoint
- [x] Create `GET /api/crm/me/interactions` endpoint
- [x] Create tests for new endpoints (tests/test_me_page.py)

### Phase 3: Hero Bar ✅
- [x] Modify hero bar to show aggregate stats for "me"
- [x] Created `renderMeHeroStats()` function

### Phase 4: Heatmap ✅
- [x] Modify heatmap to use aggregate data for "me"
- [x] Created `loadMeHeatMap()` and `loadMeInteractions()` functions
- [x] Client-side processing from interactions cache

### Phase 5: Self-Insights
- [ ] Add `mode` parameter to `PersonFactExtractor`
- [ ] Create self-insights prompt variant
- [ ] Add `POST /api/crm/me/insights/extract` endpoint
- [ ] Update UI to trigger/display self-insights
- [ ] Test insight extraction

### Phase 6: Top Contacts Widget ✅
- [x] Create top contacts component
- [x] Client-side calculation from interactions
- [x] 30-day default time period
- [x] Widget displays correctly

### Phase 7: Breakdown Charts ✅
- [x] Create 100% bar chart component
- [x] By Source chart (Gmail, iMessage, etc.)
- [x] By Month chart (last 12 months)
- [x] By Dunbar Circle chart
- [x] Charts display correctly with client-side processing

### Phase 8: Relationship Trends ✅
- [x] Create trends calculation logic (2-week comparison)
- [x] Warming relationships (increased interaction)
- [x] Cooling relationships (decreased interaction)
- [x] Create trends display component
- [x] Trends display correctly

---

## File Changes Summary

### New/Modified Backend Files
- `api/routes/crm.py` - Added `MY_PERSON_ID`, `/me/stats`, `/me/interactions` endpoints
- `api/main.py` - Added `/me` and `/me/{path}` routes for server-side routing
- `api/services/interaction_store.py` - Added `get_all_in_range()` method
- `api/services/person_facts.py` - Self-insights mode (Phase 5 - pending)

### New/Modified Frontend Files
- `web/crm.html` - Me dashboard with:
  - `isMyPage()` helper and `/me` URL routing
  - `renderMeDashboard()`, `renderMeHeroStats()`, `loadMeInteractions()`
  - `renderBreakdownCharts()`, `renderBarChart()` for 100% stacked bars
  - `renderTopContacts()` for top contacts widget
  - `renderRelationshipTrends()` for warming/cooling relationships
  - CSS styles for dashboard widgets
  - Toggle logic in `renderPersonDetail()` for Me vs regular profiles

### Test Files
- `tests/test_me_page.py` - Tests for Me page API endpoints (7 tests passing)

---

## Out of Scope

- Changes to other person's profile pages
- Changes to the Graph tab
- Mobile-specific layouts
- Caching of computed data

---

## Success Criteria

1. `/me` loads a meaningful personal dashboard
2. All widgets display accurate data
3. No regressions in existing person profile functionality
4. All new tests pass
5. Existing tests continue to pass
